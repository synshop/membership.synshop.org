<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SYN Shop Membership Management</title>

  <link rel="icon" type="image/x-icon" href="{{ url_for('static',filename='images/favicon.ico') }}">
  <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
  
  <noscript>this site requires javascript for both membership.synshop.net and synshop.auth0.com</noscript>

  <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>

  <link href="{{ url_for('static', filename='css/card-js.min.css') }}" rel="stylesheet">
  <script src="{{ url_for('static', filename='js/jquery-3.7.1.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/card-js.min.js') }}"></script>

  <script language="javascript">
 
  $( document ).ready(function() {

    $("#update_notice").hide()

    $("#newPaymentMethodTable").hide();
    $("#rowMembershipFee").hide();
    $("#rowLockerFee").hide();
    $("#rowDonation").hide();
    $("#rowCoupon").hide();

    let paymentFreqString = {};
    paymentFreqString[1] = "Every Month";
    paymentFreqString[3] = "Every 3 Months";
    paymentFreqString[6] = "Every 6 Months";
    paymentFreqString[12] = "Every 12 Months";

    const user = {
      email: "{{ session.userinfo.email }}",
      fullName: "{{ member.full_name }}",
      discordId: "{{ member.discord_id }}",
      currentPaymentMethod: "{{ member.payment_method }}",
      defaultMembershipFee: {{ mf }},
      membershipFee: 0,
      hasMembership: {{ member.membership_fee | lower }},
      membershipType: "{{ member.membership_type }}",
      defaultLockerFee: {{ lf }},
      lockerFee: 0,
      hasLocker: {{ member.locker_fee | lower }},
      membershipIsPaused: {{ member.is_paused | lower }},
      donationAmount: {{ member.donation_amount }},
      paymentFrequency: {{ member.payment_freq }},
      charterMemberCoupon: {{ member.charter_member | lower }},
      membershipFeeSubtotal: function () {
        return (this.membershipFee * this.paymentFrequency);
      },
      lockerFeeSubtotal: function () {
        return (this.lockerFee * this.paymentFrequency);
      },
      donationSubtotal: function () {
        return (this.donationAmount * this.paymentFrequency);
      },
      discountCouponSubtotal: function () {
        if (this.charterMemberCoupon == true) {
          return this.membershipFeeSubtotal() * .2
        } else {
          return 0;
        };
      },
      grandTotal: function() {
        return (this.membershipFeeSubtotal() + 
                this.lockerFeeSubtotal() + 
                this.donationSubtotal() - 
                this.discountCouponSubtotal()
        )}

    };

    function update_summary() {
      p = paymentFreqString[user.paymentFrequency];

      $("#rowMembershipFee").show();
      $("#membershipFeeAmount").html("$" + user.membershipFee);
      $("#membershipFeeFreq").html(p);
      $("#membershipFeeSubTotal").html("$" + user.membershipFeeSubtotal());
      $("#grandTotal").html("$" + user.grandTotal());

      if (user.membershipIsPaused == true) {
        $("#membershipFeeFreq").html("Membership Paused");
      }

      if (user.lockerFee != 0) {
        $("#rowLockerFee").show();
        $("#lockerFeeAmount").html("$" + user.lockerFee);
        $("#lockerFeeFreq").html(p);
        $("#lockerFeeSubTotal").html("$" + user.lockerFeeSubtotal());        
      } else {
        $("#rowLockerFee").hide();
      }

      if (user.donationAmount != 0) {
        $("#rowDonation").show();
        $("#donationAmount").html("$" + user.donationAmount);
        $("#donationFreq").html(p);
        $("#donationSubTotal").html("$" + user.donationSubtotal());     
      } else {
        $("#rowDonation").hide();
      }

      if (user.charterMemberCoupon == true) {
        $("#rowCoupon").show();
        $("#couponFreq").html(p);
        $("#couponSubTotal").html("$" + user.discountCouponSubtotal());
      }
    };

    $("#fullName").on("blur", function() {
      user.fullName = $("#fullName").val();
    });

    $("#discordId").on("blur", function() {
      user.discordId = $("#discordId").val();
    });

    $("#membershipFee").on("change", function() {

      $("#pageIsDirty").val(1);

      if ( $(this).prop("checked") == true) {
        user.membershipFee = user.defaultMembershipFee;
      } else {
        $("#lockerFee").prop("checked",false);
        user.membershipFee = 0;
      }

      update_summary();
    });

    $("#lockerFee").on("change", function() {

      $("#pageIsDirty").val(1);

      if ( $(this).prop("checked") == true) {
        $("#membershipFee").prop("checked",true);
        user.membershipFee = user.defaultMembershipFee;
        user.lockerFee = user.defaultLockerFee;
      } else {
        user.lockerFee = 0;
      }
      update_summary();
    });

    $("#pauseMembership").on("change", function() {

      $("#pageIsDirty").val(1);

      if ( $(this).prop("checked") == true) {
        user.membershipFee = 0;
        user.lockerFee = 0;
        user.membershipIsPaused = true;
        user.donationAmount = 0;
        $("#membershipFee").prop("checked",false);
        $("#membershipFee").prop("disabled",true);

        $("#lockerFee").prop("checked",false);
        $("#lockerFee").prop("disabled",true);

        $("input[name='donationRadio']").removeAttr('checked');
        $("input[name='payFreqRadio']").removeAttr('checked');
      } else {
        user.membershipIsPaused = false;
        $("#membershipFee").prop("disabled",false);
        $("#lockerFee").prop("disabled",false);
        $("#paymentFreq" + user.paymentFrequency).prop("checked", true);
      }
      update_summary();
    });

    $("input[name='donationRadio']").click(function() {
      $("#pageIsDirty").val(1);
      user.donationAmount = $("input[name='donationRadio']:checked").val() * 1;
      update_summary();
    });

    $("input[name='payFreqRadio']").click(function() {
      $("#pageIsDirty").val(1);
      user.paymentFrequency = $("input[name='payFreqRadio']:checked").val() * 1;
      update_summary();
    });

    $("#btnSubmit").click(function() {
      $(this).prop("disabled",true);
      $("#form1").trigger("submit");
    });
    
    $("#btnCancel").click(function() {
      window.location.replace("/");
    });

    $("#btnYesDelete").click(function() {
      console.log("Deleting Membership...");
      $("#reallyDeleteMembership").val(1);
      $("#form1").trigger("submit");
    });

    // Set all of the FORM elements after load

    $("#fullName").val(user.fullName);
    $("#paymentFreq" + user.paymentFrequency).prop("checked", true);
    $("#donation" + user.donationAmount).prop("checked", true);

    if (user.discordId != "None") {
      $("#discordId").val(user.discordId);
    }
 
    if (user.hasMembership) {
      user.membershipFee = user.defaultMembershipFee;
      $("#membershipFee").prop("checked",true);
    }

    if (user.hasLocker) {
      user.lockerFee = user.defaultLockerFee;
      $("#lockerFee").prop("checked",true);
    }

    if (user.membershipIsPaused) {
      user.membershipFee = 0;
      user.lockerFee = 0;
      $("#membershipFee").prop("checked",false);
      $("#membershipFee").prop("disabled",true);
      $("#lockerFee").prop("checked",false);
      $("#lockerFee").prop("disabled",true);
      $("#pauseMembership").prop("checked",true);
    }

    if (user.membershipType == "free") {
      user.membershipFee = 0;
      user.lockerFee = 0;
      $("#membershipFee").prop("checked",false);
      $("#membershipFee").prop("disabled",true);
      $("#lockerFee").prop("checked",false);
      $("#lockerFee").prop("disabled",true);
      $("#pauseMembership").prop("checked",false);
      $("#pauseMembership").prop("disabled",true);
      $('input[name=donationRadio]').attr("disabled",true);
      $('input[name=payFreqRadio]').attr("disabled",true);
    }

    $("#cardDelete").click(function() {
      console.log("deleting card " + user.currentPaymentMethod );
      $("#deleteCurrentPaymentMethod").val("1");
      $("#paymentMethodHeader").html("Payment Information - Add New Payment Method");
      $("#currentPaymentMethodTable").hide();
      $("#card-number").attr("required","required")
      $("#newPaymentMethodTable").show();
    });

    update_summary();

    {% with messages = get_flashed_messages() %}
      {% if messages %}

      $("#update_notice").show();

      $("#update_notice").fadeTo(5000, 500).slideUp(500, function(){
        $("#update_notice").slideUp(500);
      });
      
      {% endif %}
    {% endwith %}

  }); // End of document.ready

  </script>
</head>

<body>

<!-- Appearance is controlled via JS, only shows on form update refresh -->
<div class="alert alert-success" role="alert" name="update_notice" id="update_notice">
  <strong>Your membership information has been updated...</strong>
</div>

<nav class="navbar navbar-expand-sm sticky-top" style="background-color: #eee;">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">
      <img src="{{ url_for('static', filename='images/logo_horizontal.png') }}" height="64px" alt="SYN Shop Logo"></a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="{{ root_server_url }}/hours">Hours</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ root_server_url }}/events">Events</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ root_server_url }}/equipment">Equipment</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://rtfm.synshop.org">RTFM</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ root_server_url }}/about">About</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ root_server_url }}/contact">Contact</a>
        </li>
      </ul>
    </div>
  </div>
  <div>
    <ul class="navbar-nav">
    <li class="nav-item">
      <a class="nav-link" href="/logout"><b>Logout</b></a>
    </li>
  </ul>
  </div>
</nav>

<div class="container-sm" style="margin-top:25px;margin-bottom:25px;">

<form class="needs-validation" method="POST" name="form1" id="form1">
  <input type="hidden" name="email" value="{{ session.userinfo.email }}"/>
  <input type="hidden" name="stripeId" value="{{ member.stripe_id }}"/>
  <input type="hidden" name="currentPaymentMethod" value="{{ member.payment_method }}" />
  <input type="hidden" name="deleteCurrentPaymentMethod" id="deleteCurrentPaymentMethod" value="0"/>
  <input type="hidden" name="pageIsDirty" id="pageIsDirty" value="0"/>
  <input type="hidden" name="reallyDeleteMembership" id="reallyDeleteMembership"/>

    <div class="alert alert-warning" role="alert" name="notice" id="notice">
    <h4 class="alert-heading">Update Your Membership</h4>
    <hr>
    <p class="mb-0">
      If you have any questions or need help with anything, 
      please email <a href="mailto:support@synshop.org">support@synshop.org</a> 
      or reach out in the <a href="#">SYN Shop Discord</a>.
    </p>
    </div>

    {% if member.membership_type == 'free' %}
    <div class="alert alert-primary d-flex align-items-center" role="alert">
    <div>
      <h3>
        You currently have a Free Membership, please reach out to the SYN Shop 
        Board of Directors if you need to make changes.
      </h3>
    </div>
    </div>
    {% endif %}

    <!-- User Information -->
    <div class="card" style="margin-top:50px;margin-bottom:50px;">
    <h6 class="card-header">Member Information</h6>
    <div class="card-body">

      <div class="row g-3" style="margin-bottom:15px;">
        <div class="col">
          <h6 style="display:inline;margin-right:10px;padding:10px;background-color: rgb(228, 228, 228);">
            {{ session.userinfo.email }}
          </h6> 
          (This is your login, so be sure to remember it)
        </div>
      </div>
      
      <div class="row g-3">
        <div class="col">
          <input 
            type="text" 
            class="form-control input-sm" 
            placeholder="Full Name (required)"
            value=""
            name="fullName" 
            id="fullName" 
            aria-label="First name" 
            required />
        </div>
        <div class="invalid-feedback" id="invalidFullName">
          Please provide your full name.
        </div>
        <div class="col">
          <input 
            type="text" 
            class="form-control input-sm" 
            placeholder="Discord ID (optional but recommended)" 
            name="discordId" 
            id="discordId" 
            aria-label="Discord ID" />
        </div>
      </div>

    </div>
    </div>

    <!-- Subscription Information -->
    <div class="card" style="margin-bottom:25px;">
      <h6 class="card-header">Subscription Information</h6>
      <div class="card-body">

        <ul class="list-group">
          <li class="list-group-item">
            <input class="form-check-input me-1" type="checkbox" name="membershipFee" id="membershipFee">
            <label class="form-check-label" for="membershipFee">${{ mf }} - Membership Fee</label>
          </li>
          <li class="list-group-item">
            <input class="form-check-input me-1" type="checkbox" name="lockerFee" id="lockerFee">
            <label class="form-check-label" for="lockerFee">$10 - Optional Locker Fee</label>
          </li>
          </ul>
          
          <hr/>

          <ul class="list-group">
          <li class="list-group-item">
            <input class="form-check-input me-1" type="checkbox" name="pauseMembership" id="pauseMembership">
            <label class="form-check-label" for="pauseMembership">Pause Membership</label>
          </li>
        </ul>
      </div>
    </div>

    <!-- Donation Information -->
    <div class="card" style="margin-bottom:50px;">
          <h6 class="card-header">Extra Donation (Optional)</h6>
          <div class="card-body">

            <ul class="list-group">
              <li class="list-group-item">
                <input class="form-check-input me-1" type="radio" name="donationRadio" value="0" id="donation0">
                <label class="form-check-label stretched-link" for="donation0">No Thanks</label>
              </li>
              <li class="list-group-item">
                <input class="form-check-input me-1" type="radio" name="donationRadio" value="10" id="donation10">
                <label class="form-check-label stretched-link" for="donation10">$10 / Month</label>
              </li>
              <li class="list-group-item">
                <input class="form-check-input me-1" type="radio" name="donationRadio" value="20" id="donation20">
                <label class="form-check-label stretched-link" for="donation20">$20 / Month</label>
              </li>
              <li class="list-group-item">
                <input class="form-check-input me-1" type="radio" name="donationRadio" value="30" id="donation30">
                <label class="form-check-label stretched-link" for="donation30">$30 / Month</label>
              </li>
              <li class="list-group-item">
                <input class="form-check-input me-1" type="radio" name="donationRadio" value="40" id="donation40">
                <label class="form-check-label stretched-link" for="donation40">$40 / Month</label>
              </li>
              <li class="list-group-item">
                <input class="form-check-input me-1" type="radio" name="donationRadio" value="50" id="donation50">
                <label class="form-check-label stretched-link" for="donation50">$50 / Month</label>
              </li>
            </ul>
    
          </div>
    </div>

    <!-- Payment Frequency -->
    <div class="card" style="margin-bottom:50px;">
      <h6 class="card-header">Payment Frequency</h6>
      <div class="card-body">

        <ul class="list-group">
          <li class="list-group-item">
            <input class="form-check-input me-1" type="radio" name="payFreqRadio" value="1" id="paymentFreq1">
            <label class="form-check-label" for="paymentFreq1">Billed Monthly</label>
          </li>
          <li class="list-group-item">
            <input class="form-check-input me-1" type="radio" name="payFreqRadio" value="3" id="paymentFreq3">
            <label class="form-check-label" for="paymentFreq3">Billed Quarterly (every 3 months)</label>
          </li>
          <li class="list-group-item">
            <input class="form-check-input me-1" type="radio" name="payFreqRadio" value="6" id="paymentFreq6">
            <label class="form-check-label" for="paymentFreq6">Billed Semi-annually (every 6 months)</label>
          </li>
          <li class="list-group-item">
            <input class="form-check-input me-1" type="radio" name="payFreqRadio" value="12" id="paymentFreq12">
            <label class="form-check-label" for="paymentFreq12">Billed Yearly (every 12 months)</label>
          </li>
        </ul>

      </div>
    </div>

    <!-- Payment Information -->
    <div class="card" style="margin-bottom:50px;width:75%">
    <h6 class="card-header" id="paymentMethodHeader">Payment Information - Current Payment Method</h6>
    <div class="card-body">

      <div class="row g-3" id="currentPaymentMethodTable">
        <div class="col">
          <input 
            type="text" 
            class="form-control input-sm"
            value="{{ member.payment_brand | upper }}"
            name="brand" 
            id="brand" 
            disabled />
        </div>
        <div class="col">
          <input 
            type="text" 
            class="form-control input-sm"
            value="**** **** **** {{ member.last4 }}"
            name="last4" 
            id="last4" 
            disabled />
        </div>        
        <div class="col">
          <input 
            type="text" 
            class="form-control input-sm" 
            value="{{ member.exp_month }} / {{ member.exp_year }}"
            name="expDate" 
            id="expDate" 
            disabled />
        </div>
        <div class="col">
          <input 
            type="button" 
            class="btn btn-danger" 
            value="Delete Card?"
            name="cardDelete" 
            id="cardDelete" />
        </div>
      </div>

      <div class="card-js"  data-capture-name="true" id="newPaymentMethodTable">
        <input class="card-number"  name="card-number"  id="card-number">
        <input class="expiry-month" name="expiry-month" id="expiry-month">
        <input class="expiry-year"  name="expiry-year"  id="expiry-year">
        <input class="cvc"          name="cvc"          id="cvc">
      </div>
      
    </div>
    <div class="card-footer text-body-secondary">
      <div class="alert alert-warning" role="alert" style="margin-top:10px;">
        If you need to update your payment method, please delete your existing card and enter your new card 
        number, expiration date, and cvc.
      </div>
      Membership payments are processed via the <a href="https://stripe.com/">Stripe.com</a> payment 
      processing system and <span style="font-weight: bold;">your full credit card information is never 
      stored on the SYN Shop servers</span>.  Stripe maintains full audited PCI compliance and you can 
      read more about <a href="https://stripe.com/help/security"> how they have implemented security precautions here</a>.
      <br/><br/>
      <img style="display:inline;margin-left:18%;" src="{{ url_for('static', filename='images/stripe_small.png') }} "/>
      <img style="display:inline;" src="{{ url_for('static', filename='images/medlarge_stripe_cc.png') }} "/>
    </div>
    </div>

    <!-- Delete Account Demo
    <div class="card" style="margin-bottom:25px;width:75%;">
      <h6 class="card-header bg-danger text-white" 
          data-bs-toggle="collapse" 
          data-bs-target="#collapseWidthExample" 
          aria-expanded="false" 
          aria-controls="collapseWidthExample">Danger Zone - Delete Membership
        </h6>
      
      <div class="card-body" id="deleteMembership" name="deleteMembership">
        Delete account?
      </div>
    </div>
    -->

    <!-- Membership Summary -->
    <div class="card" style="width:75%;margin-bottom:15px;">
      <h6 class="card-header">Membership Summary</h6>
      <div class="card-body">

        <table class="table table-bordered">
          <thead>
            <tr>
              <th scope="col" style="background:#eee;">Item</th>
              <th scope="col" style="background:#eee;">Monthly Cost</th>
              <th scope="col" style="background:#eee;">Payment Frequency</th>
              <th scope="col" style="background:#eee;">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            <tr id="rowMembershipFee">
              <td>Membership Fee</td>
              <td id="membershipFeeAmount"></td>
              <td id="membershipFeeFreq">Monthly</td>
              <td id="membershipFeeSubTotal">$50</td>
            </tr>
            <tr id="rowLockerFee">
              <td>Locker Fee</td>
              <td id="lockerFeeAmount"></td>
              <td id="lockerFeeFreq"></td>
              <td id="lockerFeeSubTotal"></td>
            </tr>
            <tr id ="rowDonation">
              <td>Donation</td>
              <td id="donationAmount"></td>
              <td id="donationFreq"></td>
              <td id="donationSubTotal"></td>
            </tr>
            <tr id="rowCoupon">
              <td>Charter Member Coupon</td>
              <td id="couponAmount">20% Off Membership Fee</td>
              <td id="couponFreq"></td>
              <td id="couponSubTotal" style="color:red;"></td>
            </tr>         
            <tr>
             <td></td>
             <td></td>
             <th>TOTAL:</th>
             <th id="grandTotal"></th>
            </tr>
            </tbody>
        </table>

      </div>
    </div>

    <!-- Submit, Cancel and Delete Membership Controls -->
    <div class="card" style="width:75%;">
      <div class="card-body">
        <div class="row g-3">
          <div class="col">
            <button type="submit" class="btn btn-lg btn-primary" name="btnSubmit" id="btnSubmit">Submit</button>
            <button type="button" class="btn btn-lg btn-secondary" name="btnCancel" id="btnCancel">Cancel</button>
          </div>
          <div class="col" style="text-align:right;">
            <button type="button" 
                    class="btn btn-lg btn-danger" 
                    name="btnDeleteMembership" id="btnDeleteMembership" data-bs-toggle="modal" 
                    data-bs-target="#deleteMembershipModal">Delete Membership?
            </button>
          </div>
        </div>  
      </div>
    </div>

    <!-- Delete Membership Modal -->
    <div class="modal fade" id="deleteMembershipModal" tabindex="-1" aria-labelledby="deleteMembershipModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="deleteMembershipModalLabel">Delete Membership?</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>
            If you just want to take a break from SYN Shop, we suggest you 
            <strong>Pause</strong> your membership instead of permanently 
            deleting your account.  However, if you are sure you want to do 
            this, clicking the <strong>Yes, I'm sure, delete it.</strong> 
            button below will delete all traces of your existence (which 
            includes your debt / credit card and login access) in our systems.
          </p>
          <p>
            If you want to ever re-join SYN Shop, you'll have to create a new account.
          </p>

          <p class="alert alert-warning">
            If there is anything you want to let us know about before
            leaving, please reach out to the board of directors either in 
            Discord or by emailing <a href="mailto:support@synshop.org">board@synshop.org</a>
          </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Just Kidding!</button>
            <button type="button" class="btn btn-danger" id="btnYesDelete" name="btnYesDelete">Yes, I'm sure, delete it.</button>
          </div>
        </div>
      </div>
    </div>

  </form>
</div>

</body>
</html>
