<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SYN Shop Membership Management</title>

  <link rel="icon" type="image/x-icon" href="{{ url_for('static',filename='images/favicon.ico') }}">
  <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">

  <noscript>this site requires javascript for both membership.synshop.net and synshop.auth0.com</noscript>

  <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>

  <!-- 
    <link href="{{ url_for('static', filename='css/card-js.min.css') }}" rel="stylesheet">
  -->
  <script src="{{ url_for('static', filename='js/jquery-3.7.1.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/card-js.min.js') }}"></script>

  <script language="javascript">
  
  $( document ).ready(function() {

    $("#update_notice").hide()

    $("#rowMembershipFee").hide();
    $("#rowLockerFee").hide();
    $("#rowDonation").hide();
    
    jQuery.fn.preventDoubleSubmission = function() {
      $(this).on('submit',function(e){
        var $form = $(this);

        if ($form.data('submitted') === true) {
          // Previously submitted - don't submit again
          e.preventDefault();
        } else {
          // Mark it so that the next submit can be ignored
          $form.data('submitted', true);
        }
      });

      return this;
    };

    let paymentFreqString = {};
    paymentFreqString[1] = "Every Month";
    paymentFreqString[3] = "Every 3 Months";
    paymentFreqString[6] = "Every 6 Months";
    paymentFreqString[12] = "Every 12 Months";

    const user = {
      email: "{{ email }}",
      fullName: "Bobby McGee",
      discordId: "bobbyg",
      membershipFee: {{ mf }},
      defaultLockerFee: {{ lf }},
      lockerFee: 0,
      membershipIsPaused: false,
      donationAmount: 0,
      paymentFrequency: 1,
      charterMemberCoupon: false,
      membershipFeeSubtotal: function () {
        return (this.membershipFee * this.paymentFrequency)
      },
      lockerFeeSubtotal: function () {
        return (this.lockerFee * this.paymentFrequency)
      },
      donationSubtotal: function () {
        return (this.donationAmount * this.paymentFrequency)
      },
      grandTotal: function() {
        return (this.membershipFeeSubtotal() + this.lockerFeeSubtotal() + this.donationSubtotal())
      }
    };

    function update_summary() {
      p = paymentFreqString[user.paymentFrequency];

      $("#rowMembershipFee").show();
      $("#membershipFeeFreq").html(p);
      $("#membershipFeeSubTotal").html("$" + user.membershipFeeSubtotal());
      $("#grandTotal").html("$" + user.grandTotal());

      if (user.lockerFee != 0) {
        $("#rowLockerFee").show();
        $("#lockerFeeFreq").html(p);
        $("#lockerFeeSubTotal").html("$" + user.lockerFeeSubtotal());        
      } else {
        $("#rowLockerFee").hide();
      }

      if (user.donationAmount != 0) {
        $("#rowDonation").show();
        $("#donationAmount").html("$" + user.donationAmount); 
        $("#donationFreq").html(p);
        $("#donationSubTotal").html("$" + user.donationSubtotal());        
      } else {
        $("#rowDonation").hide();
      }

    };

    $("#fullName").on("blur", function() {
      user.fullName = $("#fullName").val();
      if ($(this).val() == "") {
        $("#fullname-invalid").show();
      } else {
        $("#fullname-invalid").hide();
      }
    });

    $("#discordId").on("blur", function() {
      user.discordId = $("#discordId").val();
    });

    $("#lockerFeeChk").on("change", function() {
      if ( $(this).prop("checked") == true) {
        user.lockerFee = user.defaultLockerFee;
      } else {
        user.lockerFee = 0;
      }

      update_summary();
    
    });
    
    $("input[name='donationRadio']").click(function() {
      user.donationAmount = $("input[name='donationRadio']:checked").val() * 1;
      update_summary();
    });

    $("input[name='payFreqRadio']").click(function() {
      user.paymentFrequency = $("input[name='payFreqRadio']:checked").val() * 1;
      update_summary();
    });
    
    $("#cc-number").on("blur", function() {

      var cardType = CardJs.cardTypeFromNumber($(this).val());
      var cardLength = $(this).val().length;
      var isInt = Number.isInteger($(this).val());

      if ((cardType == "Visa" || cardType == "Mastercard" || cardType == "Discover") && cardLength == 16) {
        var formatMask = CardJs.CREDIT_CARD_NUMBER_VISA_MASK;
        var card = CardJs.applyFormatMask($(this).val(),formatMask);
        $("#cc-number-invalid").hide();
        $("#btnSubmit").prop('disabled', false);
      } else if (cardType == "AMEX" && cardLength == 15) {
        var formatMask = CardJs.CREDIT_CARD_NUMBER_AMEX_MASK;
        var card = CardJs.applyFormatMask($(this).val(),formatMask);
        $("#cc-number-invalid").hide();
        $("#btnSubmit").prop('disabled', false);
      } else {
        $("#cc-number-invalid").show();
        $("#btnSubmit").prop('disabled', true);
        card = $(this).val();
      }

      $("#cc-number").val(card)
  
    });

    $("#cc-exp").on("blur", function() {

      var expDate = $(this).val() * 1;
      var expDateLength = $(this).val().length;
      var isInt = Number.isInteger(expDate);

      if (expDateLength != 4 || isInt == false) {
        $("#cc-exp-invalid").show();
        $("#btnSubmit").prop('disabled', true);
      } else {
        $("#cc-exp-invalid").hide();
        $("#btnSubmit").prop('disabled', false);
        //var mm = $(this).val().slice(0, 2);
        //var dd = $(this).val().slice(2, 4);
        //$(this).val(mm + "/" + dd);
      }
    });

    $("#cc-cvv").on("blur", function() {
      
      var cvvLength = $(this).val().length;
      var isInt = Number.isInteger($(this).val() * 1);

      if (cvvLength < 3 || isInt == false) {
        $("#cc-cvv-invalid").show();
        $("#btnSubmit").prop('disabled', true);
      } else {
        $("#cc-cvv-invalid").hide();
        $("#btnSubmit").prop('disabled', false);
      }
    });

    $("#btnCancel").click(function() {
      window.location.replace("/");
    });
    
    update_summary();
    $('#form1').preventDoubleSubmission();

    {% with messages = get_flashed_messages() %}
      {% if messages %}

      $("#update_notice").show();
      
      {% endif %}
    {% endwith %}

  }); // End of document.ready

  </script>

</head>

<body>

  <!-- Appearance is controlled via JS, only shows on form update refresh -->
  <div class="alert alert-success" role="alert" name="update_notice" id="update_notice">
    <strong>You don't appear to have a billing account, so we are starting the set up process for you</strong>
  </div>

<nav class="navbar navbar-expand-sm sticky-top" style="background-color: #eee;">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">
      <img src="{{ url_for('static', filename='images/logo_horizontal.png') }}" height="64px" alt="SYN Shop Logo"></a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="{{root_server_url }}/hours">Hours</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{root_server_url }}/events">Events</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{root_server_url }}/equipment">Equipment</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://rtfm.synshop.org">RTFM</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{root_server_url }}/about">About</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{root_server_url }}/contact">Contact</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ root_server_url }}/donate/">Donate</a>
        </li>
      </ul>
    </div>
  </div>
  <div>
    <ul class="navbar-nav">
    <li class="nav-item">
      <a class="nav-link" href="/logout"><b>Logout</b></a>
    </li>
  </ul>
  </div>
</nav>

<div class="container-sm" style="margin-top:25px;margin-bottom:25px;">

  <form method="POST" name="form1" id="form1">
  <input type="hidden" name="email" value="{{ email }}"/>

  <div class="alert alert-warning" role="alert" style="width:85%;">
    <h4 class="alert-heading">Welcome to SYN Shop!</h4>
    <p>
      Please fill out the information below to set up your account.
    </p>
    <hr>
    <p class="mb-0">
      If you have any questions or need help with anything, 
      please email <a href="mailto:support@synshop.org">support@synshop.org</a> 
      or reach out in the <a href="https://synshop.org/discord">SYN Shop Discord</a>.
    </p>
  </div>

  <!-- User Information -->
  <div class="card" style="width:85%;margin-top:50px;margin-bottom:25px;">
    <h6 class="card-header">Member Information</h6>
    <div class="card-body">
      
      <div class="row g-3">
        <div class="col-md-5">
          <label for="email" class="form-label"><b>Email (remember this!)</b></label>
          <input type="text" class="form-control" id="email" name="email" value="{{email}}" disabled>
        </div>

        <div class="col-md-3">
          <label for="fullName" class="form-label"><b>Full Name</b></label>
          <input type="text" class="form-control" id="fullName" name="fullName" placeholder="Full Name (required)" required autocomplete="on">
          <div class="invalid-feedback" id="fullname-invalid">
            Please enter your full name
          </div>
        </div>

        <div class="col-md-4">
          <label for="discordId" class="form-label"><b>Discord ID</b></label>
          <input type="text" class="form-control" id="discordId" name="discordId" placeholder="Optional, but recommended" placeholder="">
        </div>

      </div>

    </div>
  </div>

    <!-- Subscription Information -->
    <div class="card" style="width:85%;margin-bottom:25px;">
      <h6 class="card-header">Subscription Information</h6>
      <div class="card-body">

        <ul class="list-group">
          <li class="list-group-item">
            <input class="form-check-input me-1" type="checkbox" name="membershipFeeChk" id="membershipFeeChk" checked disabled>
            <label class="form-check-label" for="membershipFeeChk">$50 - Membership Fee</label>
          </li>
          <li class="list-group-item">
            <input class="form-check-input me-1" type="checkbox" name="lockerFeeChk" id="lockerFeeChk">
            <label class="form-check-label" for="lockerFeeChk">$10 - Optional Locker Fee</label>
          </li>
          </ul>
          
      </div>
    </div>

    <!-- Donation Information -->
    <div class="card" style="width:85%;margin-bottom:25px;">
          <h6 class="card-header">Extra Donation (Optional)</h6>
          <div class="card-body">

            <ul class="list-group">
              <li class="list-group-item">
                <input class="form-check-input me-1" type="radio" name="donationRadio" value="0" id="Donation0" checked>
                <label class="form-check-label stretched-link" for="Donation0">No Thanks</label>
              </li>
              <li class="list-group-item">
                <input class="form-check-input me-1" type="radio" name="donationRadio" value="10" id="Donation10">
                <label class="form-check-label stretched-link" for="Donation10">$10 / Month</label>
              </li>
              <li class="list-group-item">
                <input class="form-check-input me-1" type="radio" name="donationRadio" value="20" id="Donation20">
                <label class="form-check-label stretched-link" for="Donation20">$20 / Month</label>
              </li>
              <li class="list-group-item">
                <input class="form-check-input me-1" type="radio" name="donationRadio" value="30" id="Donation30">
                <label class="form-check-label stretched-link" for="Donation30">$30 / Month</label>
              </li>
              <li class="list-group-item">
                <input class="form-check-input me-1" type="radio" name="donationRadio" value="40" id="Donation40">
                <label class="form-check-label stretched-link" for="Donation40">$40 / Month</label>
              </li>
              <li class="list-group-item">
                <input class="form-check-input me-1" type="radio" name="donationRadio" value="50" id="Donation50">
                <label class="form-check-label stretched-link" for="Donation50">$50 / Month</label>
              </li>
            </ul>
    
          </div>
    </div>

    <!-- Payment Frequency -->
    <div class="card" style="width:85%;margin-bottom:25px;">
      <h6 class="card-header">Payment Frequency</h6>
      <div class="card-body">

        <ul class="list-group">
          <li class="list-group-item">
            <input class="form-check-input me-1" type="radio" name="payFreqRadio" value="1" id="paymentFreq1" checked>
            <label class="form-check-label" for="paymentFreq1">Billed Monthly</label>
          </li>
          <li class="list-group-item">
            <input class="form-check-input me-1" type="radio" name="payFreqRadio" value="3" id="paymentFreq3">
            <label class="form-check-label" for="paymentFreq3">Billed Quarterly (every 3 months)</label>
          </li>
          <li class="list-group-item">
            <input class="form-check-input me-1" type="radio" name="payFreqRadio" value="6" id="paymentFreq6">
            <label class="form-check-label" for="paymentFreq6">Billed Semi-annually (every 6 months)</label>
          </li>
          <li class="list-group-item">
            <input class="form-check-input me-1" type="radio" name="payFreqRadio" value="12" id="paymentFreq12">
            <label class="form-check-label" for="paymentFreq12">Billed Yearly (every 12 months)</label>
          </li>
        </ul>

      </div>
    </div>

  <!-- Payment Information -->
  <div class="card" style="width:85%;margin-bottom:25px;">
    <h6 class="card-header">Payment Information</h6>
    <div class="card-body">
      
      <div class="row g-3" style="margin-bottom:15px;">

        <div class="col-md-6">
          <label for="cc-number" class="form-label"><b>Card Number</b></label>
          <input type="text" class="form-control" id="cc-number" name="cc-number" placeholder="" required minlength="15" maxlength="16" autocomplete="on">
          <div class="invalid-feedback" id="cc-number-invalid">
            Valid card number is required
          </div>
        </div>

        <div class="col-md-3">
          <label for="cc-exp" class="form-label"><b>Expiration Date</b></label>
          <input type="text" class="form-control" id="cc-exp" name="cc-exp" placeholder="mmyy" required minlength="4" maxlength="4" autocomplete="on">
          <div class="invalid-feedback" id="cc-exp-invalid">
            Valid expiration date required
          </div>
        </div>

        <div class="col-md-3">
          <label for="cc-cvv" class="form-label"><b>CVV</b></label>
          <input type="text" class="form-control" id="cc-cvv" name="cc-cvv" placeholder="" required minlength="3" maxlength="4" autocomplete="on">
          <div class="invalid-feedback" id="cc-cvv-invalid">
            Valid security code required
          </div>
        </div>

      </div>

    </div>
    <div class="card-footer text-body-secondary">
      Membership payments are processed via the <a href="https://stripe.com/">Stripe.com</a> payment 
      processing system and <span style="font-weight: bold;">your full credit card information is never 
      stored on the SYN Shop servers</span>.  Stripe maintains full audited PCI compliance and you can 
      read more about <a href="https://stripe.com/help/security"> how they have implemented security precautions here</a>.
      <br/><br/>
      <img style="display:inline;margin-left:18%;" src="{{ url_for('static', filename='images/stripe_small.png') }} "/>
      <img style="display:inline;" src="{{ url_for('static', filename='images/medlarge_stripe_cc.png') }} "/>
    </div>
  </div>

    <!-- Membership Summary -->
    <div class="card" style="width:85%;margin-bottom:15px;">
      <h6 class="card-header">Membership Summary</h6>
      <div class="card-body">

        <table class="table table-bordered">
          <thead>
            <tr>
              <th scope="col" style="background:#eee;">Item</th>
              <th scope="col" style="background:#eee;">Monthly Cost</th>
              <th scope="col" style="background:#eee;">Payment Frequency</th>
              <th scope="col" style="background:#eee;">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            <tr id="rowMembershipFee">
              <td>Membership Fee</td>
              <td>${{ mf }}</td>
              <td id="membershipFeeFreq"></td>
              <td id="membershipFeeSubTotal"></td>
            </tr>
            <tr id="rowLockerFee">
              <td>Locker Fee</td>
              <td>${{ lf }}</td>
              <td id="lockerFeeFreq"></td>
              <td id="lockerFeeSubTotal"></td>
            </tr>
            <tr id ="rowDonation">
              <td>Donation</td>
              <td id="donationAmount"></td>
              <td id="donationFreq"></td>
              <td id="donationSubTotal"></td>
            </tr>           
            <tr>
             <td></td>
             <td></td>
             <th>TOTAL:</th>
             <th id="grandTotal"></th>
            </tr>
            </tbody>
        </table>

      </div>
    </div>

    <button type="submit" class="btn btn-lg btn-primary" name="btnSubmit" id="btnSubmit">Submit</button>
    <button type="button" class="btn btn-lg btn-secondary" name="btnCancel" id="btnCancel">Cancel</button>
</form>
</div>

</body>
</html>
